# Qwen3 Embedding RAG ç³»ç»Ÿ

åŸºäº Qwen3 åµŒå…¥æ¨¡å‹å’Œ Milvus å‘é‡æ•°æ®åº“çš„æ£€ç´¢å¢å¼ºç”Ÿæˆï¼ˆRAGï¼‰ç³»ç»Ÿã€‚

## ğŸš€ åŠŸèƒ½ç‰¹æ€§

- **å¤šæ¨¡å‹æ”¯æŒ**: æ”¯æŒ Qwen3 åµŒå…¥æ¨¡å‹ã€é‡æ’åºæ¨¡å‹å’Œ LLM
- **é«˜æ•ˆæ£€ç´¢**: åŸºäº Milvus å‘é‡æ•°æ®åº“çš„ç›¸ä¼¼æ€§æœç´¢
- **æ™ºèƒ½é‡æ’åº**: ä½¿ç”¨é‡æ’åºæ¨¡å‹ä¼˜åŒ–æ£€ç´¢ç»“æœ
- **æ‰¹é‡å¤„ç†**: æ”¯æŒå¹¶å‘å¤„ç†å’Œæ‰¹é‡æ“ä½œ
- **ç¼“å­˜æœºåˆ¶**: å†…ç½®ç¼“å­˜æå‡æ€§èƒ½
- **æ¨¡å—åŒ–è®¾è®¡**: æ¸…æ™°çš„ä»£ç ç»“æ„å’Œæ˜“äºæ‰©å±•
- **é«˜çº§é…ç½®ç®¡ç†**: æ”¯æŒJSON/YAMLæ ¼å¼ã€ç¯å¢ƒå˜é‡ã€é…ç½®éªŒè¯å’Œçƒ­é‡è½½

## ğŸ“ é¡¹ç›®ç»“æ„

```
qwen3-embedding-rag/
â”œâ”€â”€ rag/                    # ä¸»ç¨‹åºåŒ…
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ config.py          # é…ç½®ç®¡ç†ï¼ˆå·²ä¼˜åŒ–ï¼‰
â”‚   â”œâ”€â”€ document.py        # æ–‡æ¡£å¤„ç†
â”‚   â”œâ”€â”€ embedding.py       # åµŒå…¥æœåŠ¡
â”‚   â”œâ”€â”€ llm.py            # LLM æœåŠ¡
â”‚   â”œâ”€â”€ main.py           # ä¸»ç¨‹åºå…¥å£
â”‚   â”œâ”€â”€ milvus_service.py # Milvus æœåŠ¡
â”‚   â”œâ”€â”€ pipeline.py       # RAG ç®¡é“
â”‚   â”œâ”€â”€ reranker.py       # é‡æ’åºæœåŠ¡
â”‚   â””â”€â”€ utils.py          # å·¥å…·å‡½æ•°
â”œâ”€â”€ scripts/               # è„šæœ¬ç›®å½•
â”‚   â”œâ”€â”€ config_manager.py # é…ç½®ç®¡ç†å·¥å…·
â”‚   â”œâ”€â”€ config_example.py # é…ç½®ä½¿ç”¨ç¤ºä¾‹
â”‚   â”œâ”€â”€ example_usage.py  # ä½¿ç”¨ç¤ºä¾‹
â”‚   â””â”€â”€ performance_monitor.py # æ€§èƒ½ç›‘æ§
â”œâ”€â”€ docs/                  # æ–‡æ¡£ç›®å½•
â”‚   â””â”€â”€ configuration.md  # é…ç½®æŒ‡å—
â”œâ”€â”€ milvus_docs/          # æ–‡æ¡£æ•°æ®
â”œâ”€â”€ answers/              # ç­”æ¡ˆè¾“å‡ºç›®å½•
â”œâ”€â”€ logs/                 # æ—¥å¿—è¾“å‡ºç›®å½•
â”œâ”€â”€ main.py              # æ ¹ç›®å½•å¯åŠ¨è„šæœ¬
â”œâ”€â”€ config.json          # é…ç½®æ–‡ä»¶ï¼ˆå·²ä¼˜åŒ–ï¼‰
â”œâ”€â”€ config.template.yaml # YAMLé…ç½®æ¨¡æ¿
â”œâ”€â”€ requirements.txt     # ä¾èµ–åŒ…
â””â”€â”€ README.md           # é¡¹ç›®è¯´æ˜
```

## ğŸ› ï¸ å®‰è£…é…ç½®

### 1. ç¯å¢ƒå‡†å¤‡

```bash
# å…‹éš†é¡¹ç›®
git clone <repository-url>
cd qwen3-embedding-rag

# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python -m venv .venv
source .venv/bin/activate  # Linux/Mac
# æˆ– .venv\Scripts\activate  # Windows

# å®‰è£…ä¾èµ–
pip install -r requirements.txt
```

### 2. é…ç½®è®¾ç½®

#### æ–¹æ³•ä¸€ï¼šä½¿ç”¨é…ç½®æ¨¡æ¿

```bash
# ç”Ÿæˆé…ç½®æ¨¡æ¿
python scripts/config_manager.py template config.yaml --format yaml

# ç¼–è¾‘é…ç½®æ–‡ä»¶
vim config.yaml
```

#### æ–¹æ³•äºŒï¼šä½¿ç”¨ç¯å¢ƒå˜é‡

```bash
# ç”Ÿæˆç¯å¢ƒå˜é‡æ¨¡æ¿
python scripts/config_manager.py env .env.template

# å¤åˆ¶å¹¶ç¼–è¾‘ç¯å¢ƒå˜é‡æ–‡ä»¶
cp .env.template .env
vim .env
```

#### æ–¹æ³•ä¸‰ï¼šç›´æ¥ç¼–è¾‘é…ç½®æ–‡ä»¶

ç¼–è¾‘ `config.json` æ–‡ä»¶ï¼š

```json
{
  "api": {
    "openai_api_key": "",
    "openai_base_url": "http://10.172.10.103:11434/v1"
  },
  "database": {
    "milvus_uri": "http://your-milvus-server:19530",
    "collection_name": "qwen3_embedding_rag"
  },
  "models": {
    "embedding_model": "hf.co/Qwen/Qwen3-Embedding-0.6B-GGUF:Q8_0",
    "reranker_model": "qwen3:4b",
    "llm_model": "qwen3:4b"
  }
}
```

### 3. é…ç½®éªŒè¯

```bash
# éªŒè¯é…ç½®æ–‡ä»¶
python scripts/config_manager.py validate config.json

# æ˜¾ç¤ºé…ç½®ä¿¡æ¯
python scripts/config_manager.py info config.json
```

### 4. å¯åŠ¨æœåŠ¡

ç¡®ä¿ä»¥ä¸‹æœåŠ¡æ­£åœ¨è¿è¡Œï¼š
- **Ollama**: è¿è¡Œ Qwen3 æ¨¡å‹
- **Milvus**: å‘é‡æ•°æ®åº“æœåŠ¡

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### å‘½ä»¤è¡Œæ¨¡å¼

```bash
# å•æ¬¡æé—®
python main.py --question "ä½ çš„é—®é¢˜" --output-file "ç­”æ¡ˆæ–‡ä»¶.txt"

# å¼ºåˆ¶é‡å»º Milvus é›†åˆ
python main.py --force-recreate --question "ä½ çš„é—®é¢˜"

# æŒ‡å®šé…ç½®æ–‡ä»¶
python main.py --config custom_config.json --question "ä½ çš„é—®é¢˜"
```

### äº¤äº’æ¨¡å¼

```bash
python main.py
# ç„¶åè¾“å…¥é—®é¢˜ï¼Œç­”æ¡ˆä¼šè‡ªåŠ¨ä¿å­˜åˆ° answers/ ç›®å½•
```

### å‚æ•°è¯´æ˜

- `--question, -q`: è¦å›ç­”çš„é—®é¢˜
- `--force-recreate, -f`: å¼ºåˆ¶é‡å»º Milvus é›†åˆ
- `--output-file, -o`: ç­”æ¡ˆè¾“å‡ºæ–‡ä»¶è·¯å¾„ï¼ˆé»˜è®¤: answer.txtï¼‰
- `--config`: é…ç½®æ–‡ä»¶è·¯å¾„
- `--log-level`: æ—¥å¿—çº§åˆ«ï¼ˆé»˜è®¤: INFOï¼‰

## âš™ï¸ é…ç½®ç®¡ç†

### é…ç½®ç®¡ç†å·¥å…·

```bash
# éªŒè¯é…ç½®
python scripts/config_manager.py validate config.json

# è½¬æ¢é…ç½®æ ¼å¼ï¼ˆJSON â†” YAMLï¼‰
python scripts/config_manager.py convert config.json config.yaml

# ç”Ÿæˆé…ç½®æ¨¡æ¿
python scripts/config_manager.py template config.yaml --format yaml

# æ˜¾ç¤ºé…ç½®ä¿¡æ¯
python scripts/config_manager.py info config.json

# ç”Ÿæˆç¯å¢ƒå˜é‡æ¨¡æ¿
python scripts/config_manager.py env .env.template
```

### é…ç½®ä½¿ç”¨ç¤ºä¾‹

```bash
# è¿è¡Œé…ç½®ç¤ºä¾‹
python scripts/config_example.py
```

### ç¯å¢ƒå˜é‡æ”¯æŒ

| ç¯å¢ƒå˜é‡ | é…ç½®è·¯å¾„ | æè¿° |
|---------|---------|------|
| `OPENAI_API_KEY` | `api.openai_api_key` | OpenAI APIå¯†é’¥ |
| `OPENAI_BASE_URL` | `api.openai_base_url` | OpenAIå…¼å®¹APIåŸºç¡€URL |
| `MILVUS_URI` | `database.milvus_uri` | MilvusæœåŠ¡URI |
| `MILVUS_COLLECTION` | `database.collection_name` | Milvusé›†åˆåç§° |
| `LOG_LEVEL` | `logging.log_level` | æ—¥å¿—çº§åˆ« |

## ğŸ“Š è¾“å‡ºæ–‡ä»¶

### ç­”æ¡ˆæ–‡ä»¶
- **ä½ç½®**: `answers/` ç›®å½•
- **æ ¼å¼**: 
  ```
  é—®é¢˜: [ç”¨æˆ·é—®é¢˜]
  ç­”æ¡ˆ: [å®Œæ•´ç­”æ¡ˆå†…å®¹]
  
  ç”Ÿæˆæ—¶é—´: 2025-06-17 13:08:03
  ```

### æ—¥å¿—æ–‡ä»¶
- **ä½ç½®**: `logs/` ç›®å½•
- **æ–‡ä»¶**: `rag_system.log`
- **å†…å®¹**: ç³»ç»Ÿè¿è¡Œæ—¥å¿—ï¼ŒåŒ…æ‹¬é…ç½®ä¿¡æ¯ã€å¤„ç†è¿›åº¦ç­‰

## ğŸ”§ é…ç½®é€‰é¡¹

### APIé…ç½® (`api`)
| é…ç½®é¡¹ | è¯´æ˜ | é»˜è®¤å€¼ | èŒƒå›´ |
|--------|------|--------|------|
| `openai_api_key` | OpenAI APIå¯†é’¥ | `""` | - |
| `openai_base_url` | APIåŸºç¡€URL | `http://10.172.10.103:11434/v1` | - |
| `timeout` | APIè¶…æ—¶æ—¶é—´(ç§’) | `30` | 1-300 |
| `max_retries` | æœ€å¤§é‡è¯•æ¬¡æ•° | `3` | 0-10 |
| `retry_delay` | é‡è¯•å»¶è¿Ÿ(ç§’) | `1.0` | 0.1-60.0 |

### æ•°æ®åº“é…ç½® (`database`)
| é…ç½®é¡¹ | è¯´æ˜ | é»˜è®¤å€¼ | èŒƒå›´ |
|--------|------|--------|------|
| `milvus_uri` | MilvusæœåŠ¡URI | `http://10.172.10.100:19530` | - |
| `collection_name` | é›†åˆåç§° | `qwen3_embedding_rag` | - |
| `embedding_dim` | åµŒå…¥å‘é‡ç»´åº¦ | `1024` | 1-8192 |
| `metric_type` | è·ç¦»åº¦é‡ç±»å‹ | `IP` | IP/L2/COSINE |
| `consistency_level` | ä¸€è‡´æ€§çº§åˆ« | `Strong` | Strong/Bounded/Eventually/Session |
| `index_type` | ç´¢å¼•ç±»å‹ | `IVF_FLAT` | IVF_FLAT/IVF_SQ8/HNSWç­‰ |
| `nlist` | èšç±»æ•°é‡ | `1024` | â‰¥1 |
| `nprobe` | æœç´¢èšç±»æ•° | `16` | â‰¥1 |

### æ¨¡å‹é…ç½® (`models`)
| é…ç½®é¡¹ | è¯´æ˜ | é»˜è®¤å€¼ | èŒƒå›´ |
|--------|------|--------|------|
| `embedding_model` | åµŒå…¥æ¨¡å‹ | `hf.co/Qwen/Qwen3-Embedding-0.6B-GGUF:Q8_0` | - |
| `reranker_model` | é‡æ’åºæ¨¡å‹ | `qwen3:4b` | - |
| `llm_model` | å¤§è¯­è¨€æ¨¡å‹ | `qwen3:4b` | - |
| `embedding_batch_size` | åµŒå…¥æ‰¹å¤„ç†å¤§å° | `32` | 1-128 |
| `llm_max_tokens` | LLMæœ€å¤§tokenæ•° | `2048` | 1-8192 |
| `llm_temperature` | LLMæ¸©åº¦å‚æ•° | `0.7` | 0.0-2.0 |

### æ•°æ®å¤„ç†é…ç½® (`data`)
| é…ç½®é¡¹ | è¯´æ˜ | é»˜è®¤å€¼ | èŒƒå›´ |
|--------|------|--------|------|
| `data_path_glob` | æ•°æ®æ–‡ä»¶è·¯å¾„æ¨¡å¼ | `milvus_docs/en/faq/*.md` | - |
| `chunk_size` | æ–‡æœ¬åˆ†å—å¤§å° | `1000` | 100-10000 |
| `chunk_overlap` | åˆ†å—é‡å å¤§å° | `200` | 0-5000 |
| `supported_formats` | æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ | `[".md", ".txt", ".pdf"]` | - |
| `encoding` | æ–‡ä»¶ç¼–ç  | `utf-8` | - |

### æœç´¢é…ç½® (`search`)
| é…ç½®é¡¹ | è¯´æ˜ | é»˜è®¤å€¼ | èŒƒå›´ |
|--------|------|--------|------|
| `search_limit` | æœç´¢ç»“æœæ•°é‡é™åˆ¶ | `10` | 1-100 |
| `rerank_top_k` | é‡æ’åºtop-k | `3` | 1-20 |
| `similarity_threshold` | ç›¸ä¼¼åº¦é˜ˆå€¼ | `0.7` | 0.0-1.0 |
| `enable_rerank` | æ˜¯å¦å¯ç”¨é‡æ’åº | `true` | true/false |
| `enable_hybrid_search` | æ˜¯å¦å¯ç”¨æ··åˆæœç´¢ | `false` | true/false |

### æ€§èƒ½é…ç½® (`performance`)
| é…ç½®é¡¹ | è¯´æ˜ | é»˜è®¤å€¼ | èŒƒå›´ |
|--------|------|--------|------|
| `cache_size` | ç¼“å­˜å¤§å° | `1000` | 100-10000 |
| `max_workers` | æœ€å¤§å·¥ä½œçº¿ç¨‹æ•° | `4` | 1-32 |
| `batch_size` | æ‰¹å¤„ç†å¤§å° | `32` | 1-256 |
| `enable_gpu` | æ˜¯å¦å¯ç”¨GPU | `false` | true/false |
| `gpu_memory_fraction` | GPUå†…å­˜ä½¿ç”¨æ¯”ä¾‹ | `0.8` | 0.1-1.0 |

## ğŸ¯ æ€§èƒ½ä¼˜åŒ–

- **å¹¶å‘å¤„ç†**: æ”¯æŒå¤šçº¿ç¨‹å¹¶å‘å¤„ç†
- **æ‰¹é‡æ“ä½œ**: æ‰¹é‡å¤„ç†æ–‡æ¡£å’ŒåµŒå…¥
- **ç¼“å­˜æœºåˆ¶**: å†…ç½®ç¼“å­˜å‡å°‘é‡å¤è®¡ç®—
- **ç´¢å¼•ä¼˜åŒ–**: è‡ªåŠ¨åˆ›å»ºå’Œä¼˜åŒ– Milvus ç´¢å¼•
- **é…ç½®çƒ­é‡è½½**: æ”¯æŒè¿è¡Œæ—¶é‡æ–°åŠ è½½é…ç½®
- **GPUåŠ é€Ÿ**: æ”¯æŒGPUåŠ é€Ÿè®¡ç®—

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **Milvus è¿æ¥å¤±è´¥**
   - æ£€æŸ¥ Milvus æœåŠ¡æ˜¯å¦å¯åŠ¨
   - éªŒè¯è¿æ¥åœ°å€å’Œç«¯å£

2. **æ¨¡å‹åŠ è½½å¤±è´¥**
   - ç¡®ä¿ Ollama æœåŠ¡è¿è¡Œ
   - æ£€æŸ¥æ¨¡å‹åç§°æ˜¯å¦æ­£ç¡®

3. **å†…å­˜ä¸è¶³**
   - å‡å°‘æ‰¹å¤„ç†å¤§å°
   - è°ƒæ•´å¹¶å‘æ•°é‡

4. **é…ç½®éªŒè¯å¤±è´¥**
   - ä½¿ç”¨é…ç½®ç®¡ç†å·¥å…·éªŒè¯é…ç½®
   - æ£€æŸ¥æ•°å€¼æ˜¯å¦åœ¨æœ‰æ•ˆèŒƒå›´å†…
   - ç¡®è®¤é€»è¾‘çº¦æŸæ˜¯å¦æ»¡è¶³

### æ—¥å¿—æŸ¥çœ‹

```bash
# æŸ¥çœ‹æœ€æ–°æ—¥å¿—
tail -f logs/rag_system.log

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
grep ERROR logs/rag_system.log
```

### é…ç½®è°ƒè¯•

```bash
# éªŒè¯é…ç½®æ–‡ä»¶
python scripts/config_manager.py validate config.json

# æ˜¾ç¤ºé…ç½®ä¿¡æ¯
python scripts/config_manager.py info config.json

# è¿è¡Œé…ç½®ç¤ºä¾‹
python scripts/config_example.py
```

## ğŸ“ å¼€å‘è¯´æ˜

### ä»£ç ç»“æ„

- **æ¨¡å—åŒ–è®¾è®¡**: æ¯ä¸ªåŠŸèƒ½æ¨¡å—ç‹¬ç«‹å°è£…
- **é…ç½®é©±åŠ¨**: é€šè¿‡é…ç½®æ–‡ä»¶æ§åˆ¶è¡Œä¸º
- **é”™è¯¯å¤„ç†**: å®Œå–„çš„å¼‚å¸¸å¤„ç†æœºåˆ¶
- **æ—¥å¿—è®°å½•**: è¯¦ç»†çš„æ—¥å¿—è®°å½•ä¾¿äºè°ƒè¯•
- **é…ç½®éªŒè¯**: å®Œæ•´çš„é…ç½®éªŒè¯å’Œç±»å‹æ£€æŸ¥

### æ‰©å±•å¼€å‘

1. **æ·»åŠ æ–°æ¨¡å‹**: åœ¨å¯¹åº”æœåŠ¡ç±»ä¸­æ·»åŠ æ¨¡å‹æ”¯æŒ
2. **è‡ªå®šä¹‰å¤„ç†å™¨**: ç»§æ‰¿åŸºç¡€ç±»å®ç°è‡ªå®šä¹‰é€»è¾‘
3. **é…ç½®æ‰©å±•**: åœ¨é…ç½®ç±»ä¸­æ·»åŠ æ–°çš„é…ç½®é¡¹
4. **é…ç½®éªŒè¯**: æ·»åŠ è‡ªå®šä¹‰éªŒè¯è§„åˆ™

### é…ç½®ç³»ç»Ÿç‰¹æ€§

- **ç±»å‹å®‰å…¨**: ä½¿ç”¨Pydanticè¿›è¡Œç±»å‹éªŒè¯
- **ç¯å¢ƒå˜é‡æ”¯æŒ**: æ”¯æŒç¯å¢ƒå˜é‡è¦†ç›–é…ç½®
- **çƒ­é‡è½½**: æ”¯æŒè¿è¡Œæ—¶é‡æ–°åŠ è½½é…ç½®
- **å¤šæ ¼å¼æ”¯æŒ**: æ”¯æŒJSONå’ŒYAMLæ ¼å¼
- **é…ç½®éªŒè¯**: å®Œæ•´çš„é…ç½®éªŒè¯å’Œçº¦æŸæ£€æŸ¥
- **é…ç½®ç®¡ç†å·¥å…·**: æä¾›é…ç½®éªŒè¯ã€è½¬æ¢ã€ç”Ÿæˆå·¥å…·

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ã€‚

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š
- [é¡¹ç›® Issues](../../issues)
- [é…ç½®æŒ‡å—](./docs/configuration.md)
- [æ–‡æ¡£è¯´æ˜](./docs/)